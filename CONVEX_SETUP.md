# Convex Database Setup - DomiEuro

## Overview
This project now includes a fully configured Convex database with a `users` table that integrates with WorkOS authentication.

## Database Schema

### Users Table
- **email**: string (indexed) - User's email address
- **name**: string - User's display name
- **createdAt**: number (timestamp, indexed) - Creation timestamp
- **updatedAt**: number (timestamp) - Last update timestamp
- **isActive**: boolean - Whether the user account is active
- **workosUserId**: **REQUIRED** string (indexed) - WorkOS user ID (required for authentication)
- **organizationId**: **REQUIRED** string (indexed) - WorkOS organization ID (required for multi-tenant support)

## Available Functions

### Queries
- `getAllUsers()` - Get all users
- `getUserByEmail(email)` - Get user by email address
- `getUserByWorkosId(workosUserId)` - Get user by WorkOS ID
- `getUsersByOrganization(organizationId)` - Get users in an organization

### Mutations
- `createUser({ email, name, workosUserId, organizationId })` - Create new user (workosUserId and organizationId are REQUIRED)
- `updateUser({ id, name?, email?, isActive?, organizationId? })` - Update user
- `deactivateUser({ id })` - Deactivate user (soft delete)

**Note**: When creating users, both `workosUserId` and `organizationId` are required fields. The authentication flow automatically handles user creation after successful WorkOS authentication.

## Setup Steps

1. **Environment Variables**
   ```bash
   cp .env.example .env
   ```
   Add your Convex deployment URL to `.env` (you'll get this URL in the next step):
   ```
   CONVEX_URL=https://your-deployment.convex.cloud
   VITE_CONVEX_URL=https://your-deployment.convex.cloud
   ```

2. **Initialize Convex Development Environment**
   ```bash
   npx convex dev
   ```
   This will:
   - Create a new Convex deployment (if you don't have one)
   - Provide you with the deployment URL to add to your `.env` file
   - Generate TypeScript types in `convex/_generated/`
   - Watch for changes and automatically deploy updates

3. **Run Type Generation** (if needed)
   After schema changes, regenerate types:
   ```bash
   npx convex codegen
   ```

## Usage in Your Application

1. **Wrap Your App with ConvexProvider**
   ```tsx
   import { ConvexClientProvider } from "./lib/ConvexProvider";

   function App() {
     return (
       <ConvexClientProvider>
         {/* Your app components */}
       </ConvexClientProvider>
     );
   }
   ```

2. **Use the Database Hooks**
   ```tsx
   import { useGetAllUsers, useCreateUser } from "./lib/useConvex";

   function MyComponent() {
     const users = useGetAllUsers();
     const createUser = useCreateUser();

     const handleCreate = () => {
       // Note: workosUserId and organizationId are REQUIRED
       createUser({
         email: "user@example.com",
         name: "New User",
         workosUserId: "user_123",  // From WorkOS authentication
         organizationId: "org_456"   // From WorkOS authentication
       });
     };

     return (
       <div>
         {users?.map(user => (
           <div key={user._id}>{user.name}</div>
         ))}
       </div>
     );
   }
   ```

## Files Created
- `convex.json` - Convex configuration
- `convex/schema.ts` - Database schema definition
- `convex/users.ts` - User CRUD operations
- `lib/convex.ts` - Convex client setup
- `lib/ConvexProvider.tsx` - React provider component
- `lib/useConvex.ts` - Custom hooks for database operations
- `components/UsersDemo.tsx` - Demo component for testing

## Type Safety
All database operations are fully type-safe with TypeScript. The Convex CLI automatically generates types based on your schema and functions.

## Generated Files & Version Control
The `convex/_generated/` directory contains TypeScript types auto-generated by Convex:
- **Should you commit it?** It's recommended to add `convex/_generated/` to `.gitignore` and regenerate types after cloning
- **When are types generated?** Automatically when running `npx convex dev` or manually with `npx convex codegen`
- **What if types are missing?** Run `npx convex codegen` to regenerate them

## Important Notes
- The authentication flow automatically creates users in Convex after successful WorkOS authentication
- Both `workosUserId` and `organizationId` are required fields - you cannot create users without these
- User creation happens server-side in the auth callback route (`app/routes/auth/callback.tsx`)
- Manual user creation should only be done through the authentication flow, not directly through mutations